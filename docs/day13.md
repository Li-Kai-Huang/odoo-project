# Day 13 --- 報表 & 匯出（Smart Button、PDF、Excel）

今天算是我們的 **「資料可攜性日」**。\
到目前為止，零件的進出庫能記錄、能查，但還停留在 Odoo 介面內。\
如果主管問：「能不能給我一張報表？」或「能不能把這個月的出入庫給我
Excel？」------我們就啞口無言。

所以今天的目標就是：\

1. 把資料用 **Smart Button** 串起來，快速連到正確的紀錄。\
2. 可以一鍵產生 **PDF 報表**（好看、正式，適合列印）。\
3. 可以透過精靈產生 **Excel 匯出**（靈活，方便二次處理）。

------------------------------------------------------------------------

## 1) 為什麼要做這些？

- **Smart Button**：解決「找資料太麻煩」的痛點。\
    在 Part 的表單裡直接放按鈕，讓使用者不用自己去過濾 Move
    清單。對一般使用者來說，這是超級直覺的 UX 優化。

- **PDF 報表**：

  - 適合拿去審核、存檔或印給主管簽名。\
  - 格式統一，結構清楚。\
  - 小缺點是互動性低，適合「固定格式」。

- **Excel 匯出**：

  - 這是「萬用武器」，幾乎每個主管、財務或倉管人員都會要 Excel。\
  - 好處是彈性高，可以自行做圖表、統計。\
  - 缺點是安全性低，檔案一傳就脫離了系統控管。

換句話說，這三個功能不是在堆疊「炫技」，而是真正對應到日常需求。

------------------------------------------------------------------------

## 2) 做法與技術細節

### (A) Smart Button

- Action：`ir.actions.act_window`，domain 用
    `"[('part_id','=',active_id)]"`，讓它只撈當前零件的 Move。\
- UI：在 Part 的 form header 加
    `<button class="oe_stat_button" .../>`。\
- 好處：**不會污染主選單**，主選單還是能看所有
    Moves；但在零件頁，使用者可以一鍵直達該零件的歷史。

### (B) PDF 報表

- 新增一個 `ir.actions.report`，報表類型是 `qweb-pdf`。\
- 模板要注意 2 個坑：
    1. 外層一定要
        `<t t-call="web.html_container"><main>...</main></t>`，不然會報
        `IndexError: list index out of range`。\
    2. 要先 `t-set="company"`，不然 `external_layout_standard` 會
        KeyError。
- 我們做的內容很簡單：顯示料號、名稱、庫存數量、團隊、描述。\
    但這已經是一個「正式文件」的雛型，未來要加 Logo、簽名區、甚至 QRCode
    都很方便。

### (C) Excel 匯出

- 做了一個 Wizard：`parts.inventory.export.moves.wizard`。\
- 使用 transient model，欄位有 `part_id`、`date_from`、`date_to`。\
- 核心方法 `action_export_xlsx()`：
  - 搜尋符合條件的 Moves\
  - 用 `xlsxwriter`（或 Odoo 的報表 API）動態產檔\
  - 回傳檔案下載
- UI：在 Part 表單 header 放一顆「Export Excel」按鈕 → 觸發 wizard →
    輸入條件 → 下載。

------------------------------------------------------------------------

## 3) 今日踩到的坑 & 心得

- **外部 ID 找不到**：\
    這是最常見的錯誤，幾乎每天都踩。\
    解法是要養成習慣：**每一顆按鈕、每一個 action，都先確認 XML 裡有
    `record id=...` 定義**，而且 `__manifest__.py` 的 data 列表要載入。

- **active_id 報錯**：\
    主選單沒有 active_id，所以 domain 裡不能硬用它。\
    → 解法：Smart Button action 才用 active_id；主選單 action domain
    一律留空。

- **team_id 不存在**：\
    原因是 related field 沒加 `store=True`，導致 domain 搜尋不到。\
    → 解法：加上 store，然後重新升級模組。

- **PDF 報 KeyError: company**：\
    → 必須手動 t-set company。這是 Odoo 17 才有的「強制規則」。

- **Excel wizard 欄位亂加**：\
    一開始我硬塞 `team_id` 到 wizard，但 model 沒有 → 安裝直接爆掉。\
    → 教訓：Wizard model 要加什麼欄位，一定要先在 Python 定義好。

------------------------------------------------------------------------

## 4) 我對這次設計的評論

這一天的工作不像前幾天那麼「硬核」(寫 model、搞交易回滾)，更多是偏「UX +
報表設計」。\
實際上這種需求，在企業專案裡會被瘋狂要求，因為 **「看得見 / 帶得走」**
比「系統內有」更重要。

- PDF：讓資料「有格式」→ 外部溝通的橋樑。\
- Excel：讓資料「可運算」→ 內部分析的利器。\
- Smart Button：讓資料「好找」→ 每天工作的小確幸。

------------------------------------------------------------------------

## 5) 驗收清單

- [x] Part 表單有 Smart Button，可直達 Moves\
- [x] 點 PDF 可下載單張報表\
- [x] 點 Excel 可選條件匯出檔案\
- [x] 主選單開得起來，不再報錯\
- [x] 權限設定正確（至少 Internal User 能用）

------------------------------------------------------------------------

## 6) 明日展望（Day 14）

明天要做更「流程性」的功能：**審核 / 權限控管**。\
也就是說，入庫單不是誰都能直接 Confirm，可能要「草稿 → 送審 → 核准 →
完成」。\
同時不同角色（倉管 / 組長 /
管理員）要有不同操作權限，這才算接近真實場景。
